name: Performance Benchmarking

on:
  pull_request:
    branches: [ main ]
  # Optional: run weekly to keep history updated
  schedule:
    - cron: '0 0 * * SUN' 

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      # Required for the benchmark action to comment on PRs/store results
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required for history comparison

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies and benchmarking tools
      run: |
        python -m pip install --upgrade pip
        # Install all project dependencies
        pip install matplotlib sympy scipy pytest pytest-benchmark
        # Set PYTHONPATH if needed, as before
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src

    - name: Run benchmarks with pytest-benchmark
      run: |
        # Assume you have a specific test file for benchmarks, e.g., tests/benchmarks/benchmark_solver.py
        pytest tests/benchmarks/benchmark_solver.py --benchmark-json=benchmarks.json

    - name: Store benchmark results and detect regressions
      # Uses a third-party action to visualize results and alert on slowdowns
      uses: benchmark-action/github-action-benchmark@v1.17.0
      with:
        name: My DSL Solver Benchmark
        tool: 'pytest'
        output-file-path: benchmarks.json
        # Check for regressions, fail workflow if threshold exceeded
        fail-on-benchmark-diff: true
        alert-threshold: 200% # Fail if 2x slower
